resources:
- name: instance-template
  type: compute.v1.instanceTemplate
  properties:
    properties:
      tags:
        items:
          - http-server
      machineType: f1-micro
      canIpForward: false
      disks:
      - deviceName: boot
        type: PERSISTENT
        boot: true
        autoDelete: true
        initializeParams:
          sourceImage: https://www.googleapis.com/compute/v1/projects/gce-uefi-images/global/images/ubuntu-1804-bionic-v20181222
      networkInterfaces:
      - network: https://www.googleapis.com/compute/v1/projects/precise-sight-228704/global/networks/default
      scheduling:
        onHostMaintenance: MIGRATE
        automaticRestart: true
      serviceAccounts:
        - email: default
          scopes:
          - https://www.googleapis.com/auth/compute.readonly
          - https://www.googleapis.com/auth/devstorage.read_only
          - https://www.googleapis.com/auth/service.management.readonly
      metadata:
        items:
        - key: startup-script
          value: |
            #!/bin/bash
            apt-get update -y
            apt-get install apache2 -y
            cat <<EOF > /var/www/html/index.html
            <html>
            <body>
            <title>Apache Server - $(hostname)</title>
            <p><b>Hostname:</b> $(hostname)</p>
            <p>A <b>Packer</b> built, <b>Deployment Manager</b> deployed, <b>GCP</b> Auto Scalling, Managed Instance Group with Load Balancer serving <b>Apache Web Server</b></p>
            </body>
            </html>
            EOF
- name: instance-group
  type: compute.v1.instanceGroupManagers
  properties:
    baseInstanceName: apache
    instanceTemplate: $(ref.instance-template.selfLink)
    targetSize: 2
    zone: northamerica-northeast1-a
- name: apache-as
  type: compute.v1.autoscaler
  properties:
    zone: northamerica-northeast1-a
    target: $(ref.instance-group.selfLink)
    autoscalingPolicy:
      maxNumReplicas: 5

